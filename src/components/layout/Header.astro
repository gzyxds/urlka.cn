---
// 现代化简约风格的菜单分类结构
// 优化移动端响应式设计，确保内容不溢出屏幕

// 导入 @iconify/react 组件库
import { Icon } from '@iconify/react';

// 图标缓存，避免重复创建
const iconCache = new Map();

// 根据菜单项标题返回对应的iconify图标名称
function getMenuIcon(title: string): string {
  if (iconCache.has(title)) {
    return iconCache.get(title);
  }
  
  const icons: Record<string, string> = {
    "热门产品": "heroicons:fire",
    "172知识库": "heroicons:book-open",
    "APP下载": "heroicons:device-phone-mobile",
    "在线领卡": "heroicons:credit-card",
    "飞利猫": "heroicons:wifi",
    "代理登入": "heroicons:user",
    "订单查询": "heroicons:clipboard-document-list",
    "在线客服": "heroicons:chat-bubble-left-right",
    "常见问题": "heroicons:question-mark-circle",
    "在线留言": "heroicons:pencil-square",
    "公司介绍": "heroicons:building-office",
    "联系我们": "heroicons:phone",
    "加入我们": "heroicons:user-group",
    "合作伙伴": "heroicons:briefcase",
    "艺创官网": "heroicons:globe-alt",
    "数字分身": "heroicons:user-circle",
    "艺创AI": "heroicons:light-bulb",
    "优刻云": "heroicons:cloud-arrow-up",
  };
  
  const icon = icons[title] || "heroicons:chevron-right";
  iconCache.set(title, icon);
  return icon;
}

// 菜单描述映射
const menuDescriptions: Record<string, string> = {
  "产品服务": "探索我们的产品和服务，为您提供全方位的解决方案",
  "服务中心": "专业的客户服务支持，随时为您提供帮助",
  "关于我们": "了解我们的公司文化和发展历程",
  "合作产品": "精选合作伙伴产品，为您提供更多选择",
};

// 菜单链接映射
const menuLinks: Record<string, string> = {
  "产品服务": "/Product",
  "服务中心": "/online",
  "关于我们": "/about",
  "合作产品": "#",
};

// 快速链接描述
const quickLinkDesc: Record<string, string> = {
  "首页": "返回首页",
  "新闻资讯": "最新动态",
  "飞利猫": "随身WiFi",
};

const menuitems = [
  { title: "首页", path: "/#home" },
  {
    title: "产品服务",
    path: "javascript:void(0)",
    children: [
      { title: "热门产品", path: "/Product", external: false, description: "172号卡精选热门产品，满足您的各种需求" },
      { title: "172知识库", path: "/base", external: false, description: "丰富的知识资源，助您快速上手" },
      { title: "APP下载", path: "/app", external: false, description: "便捷的移动应用，随时随地使用" },
      { title: "在线领卡", path: "/card", external: false, description: "快速在线办理，即时生效使用" },
      { title: "飞利猫", path: "/caict", external: false, description: "专业的随身WiFi解决方案" },
    ],
  },
  {
    title: "服务中心",
    path: "javascript:void(0)",
    children: [
      { title: "代理登入", path: "/signup", external: false, description: "代理商专用登录入口" },
      { title: "订单查询", path: "/OrderInquiry", external: false, description: "快速查询订单状态和物流信息" },
      { title: "在线客服", path: "/online", external: false, description: "7×24小时在线客服支持" },
      { title: "常见问题", path: "/fqa", external: false, description: "常见问题解答，自助服务" },
      { title: "在线留言", path: "/message", external: false, description: "在线留言反馈，及时响应" },
    ],
  },
  {
    title: "关于我们",
    path: "javascript:void(0)",
    children: [
      { title: "公司介绍", path: "/about", external: false, description: "了解公司发展历程和企业文化" },
      { title: "联系我们", path: "/contact", external: false, description: "多种联系方式，随时为您服务" },
      { title: "加入我们", path: "/join", external: false, description: "优秀人才招聘，共创美好未来" },
      { title: "合作伙伴", path: "/partners", external: false, description: "优质合作伙伴，共同发展" },
    ],
  },
  { title: "新闻资讯", path: "/blog" },
  { title: "飞利猫", path: "/feilimao" },
  {
    title: "合作产品",
    path: "javascript:void(0)",
    children: [
      { title: "艺创官网", path: "https://urlnet.cn", external: true, description: "专业的网络服务提供商" },
      { title: "数字分身", path: "https://v.cnai.art", external: true, description: "AI数字人技术领先平台" },
      { title: "艺创AI", path: "https://www.cnai.art", external: true, description: "人工智能创新应用平台" },
      { title: "优刻云", path: "https://www.cloudcvm.com/", external: true, description: "高性能云计算服务商" },
    ],
  },
];

// 获取菜单键名
function getMenuKey(title: string): string {
  const keyMap: Record<string, string> = {
    "产品服务": "showProductMenu",
    "服务中心": "showServiceMenu",
    "关于我们": "showAboutMenu",
    "合作产品": "showPartnerMenu",
  };
  return keyMap[title] || "showMenu";
}
---

<header 
  x-data="{ navbarOpen: false, showProductMenu: false, showServiceMenu: false, showAboutMenu: false, showPartnerMenu: false }"
  class="sticky top-0 z-50 w-full bg-white dark:bg-black backdrop-blur-lg transition-all duration-300 border-b border-gray-100 dark:border-blue-900/20 shadow-sm"
>
  <div class="container mx-auto px-3 sm:px-4 lg:px-8 xl:px-12">
    <div class="flex h-16 sm:h-20 items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center min-w-0 flex-shrink-0">
        <a href="/" class="flex items-center gap-2 sm:gap-3 py-2 group">
          <div class="flex items-center gap-2 sm:gap-3">
            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center overflow-hidden group-hover:scale-105 transition-transform duration-200">
              <img src="/assets/logo/172.png" alt="172号卡 Logo" class="w-full h-full object-cover" width="40" height="40" loading="lazy" />
            </div>
            <div class="flex flex-col min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white truncate">172号卡</span>
                <span class="px-2 py-1 text-xs font-normal bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full leading-none">官网</span>
              </div>
              <span class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block truncate">分销管理平台</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden lg:flex lg:items-center lg:space-x-1 xl:space-x-4 flex-1 justify-center max-w-4xl">
        {menuitems.map((item) => {
          if (!item.children) {
            return <a href={item.path} class="nav-link whitespace-nowrap">{item.title}</a>;
          }
          
          const menuKey = getMenuKey(item.title);
          
          return (
            <div 
              class="relative group" 
              @mouseenter={`${menuKey} = true`} 
              @mouseleave={`${menuKey} = false`}
              @click.outside={`${menuKey} = false`}
            >
              <button @click={`${menuKey} = !${menuKey}`} class="nav-link flex items-center whitespace-nowrap">
                {item.title}
                <Icon client:load icon="heroicons:chevron-down" className="ml-1 h-3 w-3 transition-transform duration-200" :class={`${menuKey} ? 'rotate-180' : ''}`} />
              </button>
              
              <!-- Mega Menu Container -->
              <div 
                x-show={menuKey}
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-2"
                class="absolute left-1/2 transform -translate-x-1/2 mt-3 w-[90vw] max-w-xl rounded-lg bg-white dark:bg-dark-2 shadow-lg ring-1 ring-gray-200 dark:ring-dark-3 overflow-visible"
                style="display: none;"
              >
                <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white dark:bg-dark-2 rotate-45 border-l border-t border-gray-200 dark:border-dark-3"></div>
                
                <!-- Menu Header -->
                <div class="p-4 border-b border-gray-100 dark:border-dark-3">
                  <div class="mb-3">
                    <h4 class="text-sm font-bold text-dark dark:text-white mb-1 flex items-center gap-2">
                      <span class="w-1 h-4 bg-primary rounded-full"></span>
                      {item.title}
                    </h4>
                    <p class="text-xs text-body-color dark:text-dark-6">{menuDescriptions[item.title] || ""}</p>
                  </div>
                  
                  <!-- Menu Items Grid -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {item.children.map((childItem) => (
                      <a 
                        href={childItem.path}
                        target={childItem.external ? "_blank" : "_self"}
                        rel={childItem.external ? "noopener noreferrer" : undefined}
                        class="group flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-2 transition-colors duration-200 border border-transparent hover:border-gray-200 dark:hover:border-dark-3"
                      >
                        <div class="flex-shrink-0 w-8 h-8 bg-primary/10 text-primary rounded-lg flex items-center justify-center">
                          <Icon client:load icon={getMenuIcon(childItem.title)} className="w-4 h-4" />
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="text-sm font-semibold text-dark dark:text-white group-hover:text-primary transition-colors truncate mb-0.5">
                            {childItem.title}
                          </div>
                          <div class="text-xs text-body-color dark:text-dark-6 line-clamp-1">{childItem.description}</div>
                        </div>
                      </a>
                    ))}
                  </div>
                </div>
                
                <!-- Menu Footer -->
                <div class="px-5 py-3 border-t border-gray-100 dark:border-dark-3">
                  <a 
                    href={menuLinks[item.title] || "#"}
                    class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-primary hover:bg-primary/5 rounded-lg transition-colors"
                  >
                    查看全部{item.title}
                    <Icon client:load icon="heroicons:chevron-right" className="w-4 h-4" />
                  </a>
                </div>
              </div>
            </div>
          );
        })}
      </nav>

      <!-- Right Side Actions -->
      <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0">
        <!-- Auth Buttons -->
        <div class="hidden sm:flex items-center gap-2">
          <a 
            href="https://haoka.lot-ml.com/plugreg.html?agentid=90925"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 px-5 py-2.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors"
          >
            <Icon client:load icon="heroicons:user-plus" className="w-4 h-4" />
            <span>注册</span>
          </a>
          
          <a 
            href="https://haoka.lot-ml.com/login.html"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 px-5 py-2.5 bg-white text-dark text-sm font-medium rounded-lg border border-gray-200 hover:bg-gray-50 hover:border-gray-300 transition-colors dark:bg-dark-2 dark:text-white dark:border-dark-3 dark:hover:bg-dark-3"
          >
            <Icon client:load icon="heroicons:arrow-left-on-rectangle" className="w-4 h-4" />
            <span>登入</span>
          </a>
        </div>
        
        <!-- Mobile Menu Button -->
        <button 
          @click="navbarOpen = !navbarOpen"
          :class="navbarOpen && 'navbarTogglerActive'"
          class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-blue-900/20 transition-all duration-200 group"
          aria-label="切换菜单"
        >
          <Icon 
            client:load
            x-show="!navbarOpen"
            icon="heroicons:bars-3" 
            className="h-6 w-6 text-gray-700 dark:text-gray-200 transition-all duration-200" 
          />
          <Icon 
            client:load
            x-show="navbarOpen"
            icon="heroicons:x-mark" 
            className="h-6 w-6 text-gray-700 dark:text-gray-200 transition-all duration-200" 
          />
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div 
    x-show="navbarOpen" 
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform -translate-y-4"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100 transform translate-y-0"
    x-transition:leave-end="opacity-0 transform -translate-y-4"
    class="lg:hidden absolute top-full left-0 right-0 bg-white dark:bg-blue-950 backdrop-blur-md border-t border-gray-200 dark:border-blue-900/30 shadow-xl z-50"
    style="display: none;"
  >
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 max-h-[calc(100vh-80px)] overflow-y-auto">
      <!-- Mobile Navigation Items -->
      <nav class="flex flex-col space-y-1.5">
        {menuitems.map((item) => (
          <div class="mobile-nav-item">
            {item.children ? (
              <div x-data="{ open: false }" class="rounded-xl bg-gray-50 dark:bg-gray-800 p-2 dark:border dark:border-gray-700">
                <button 
                  @click="open = !open"
                  class="flex items-center justify-between w-full py-2 px-2.5 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/50 transition-all duration-200"
                >
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-lg bg-blue-500 dark:bg-blue-600 flex items-center justify-center mr-2.5">
                      <Icon client:load icon="heroicons:bars-3" className="h-4 w-4 text-white" />
                    </div>
                    <div class="flex flex-col items-start">
                      <span class="text-sm font-semibold text-gray-900 dark:text-white">{item.title}</span>
                      <span class="text-[10px] text-gray-500 dark:text-gray-400">{menuDescriptions[item.title] || ""}</span>
                    </div>
                  </div>
                  <Icon 
                    client:load
                    icon="heroicons:chevron-down"
                    :class="open ? 'rotate-180' : ''"
                    className="h-4 w-4 text-gray-400 dark:text-gray-500 transition-transform duration-200 flex-shrink-0"
                  />
                </button>
                
                <div 
                  x-show="open"
                  x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 max-h-0"
                  x-transition:enter-end="opacity-100 max-h-96"
                  x-transition:leave="transition ease-in duration-150"
                  x-transition:leave-start="opacity-100 max-h-96"
                  x-transition:leave-end="opacity-0 max-h-0"
                  class="overflow-hidden mt-2"
                  style="display: none;"
                >
                  <div class="p-2 bg-white dark:bg-gray-900 rounded-lg dark:border dark:border-gray-700">
                    <div class="grid grid-cols-2 gap-1.5">
                      {item.children.map((child) => (
                        <a 
                          href={child.path}
                          target={child.path.startsWith('http') ? '_blank' : '_self'}
                          rel={child.path.startsWith('http') ? 'noopener noreferrer' : ''}
                          class="flex flex-col items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/50 transition-all duration-200"
                        >
                          <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900 flex items-center justify-center mb-1">
                            <Icon client:load icon={getMenuIcon(child.title)} className="w-4 h-4 text-blue-600 dark:text-blue-400" />
                          </div>
                          <div class="flex flex-col items-center text-center">
                            <span class="font-semibold text-gray-800 dark:text-gray-200 text-xs mb-0.5">{child.title}</span>
                            <span class="text-[10px] text-gray-500 dark:text-gray-400 leading-snug line-clamp-2">{child.description}</span>
                          </div>
                        </a>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            ) : (
              <a 
                href={item.path}
                target={item.path.startsWith('http') ? '_blank' : '_self'}
                rel={item.path.startsWith('http') ? 'noopener noreferrer' : ''}
                class="flex items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/50 transition-all duration-200"
              >
                <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900 flex items-center justify-center mr-2.5">
                  <Icon client:load icon="heroicons:chevron-right" className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                </div>
                <div class="flex flex-col">
                  <span class="font-semibold text-gray-800 dark:text-gray-200 text-sm">{item.title}</span>
                  <span class="text-[10px] text-gray-500 dark:text-gray-400">{quickLinkDesc[item.title] || ""}</span>
                </div>
              </a>
            )}
          </div>
        ))}
      </nav>
      
      <!-- Mobile Auth Buttons -->
      <div class="mt-4 pt-3 space-y-2">
        <div class="p-3 bg-blue-50 dark:bg-blue-950 rounded-xl dark:border dark:border-blue-900">
          <div class="flex items-center mb-2">
            <div class="w-6 h-6 rounded-full bg-blue-500 dark:bg-blue-600 flex items-center justify-center mr-2">
              <Icon client:load icon="heroicons:user" className="h-3 w-3 text-white" />
            </div>
            <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">账户中心</span>
          </div>
          <div class="grid grid-cols-2 gap-1.5">
            <a 
              href="https://haoka.lot-ml.com/login.html"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-3 py-2 bg-white dark:bg-blue-900 text-gray-900 dark:text-white font-semibold rounded-lg border border-gray-200 dark:border-blue-900 hover:bg-gray-50 dark:hover:bg-blue-800 transition-all duration-200 text-xs"
            >
              <Icon client:load icon="heroicons:arrow-left-on-rectangle" className="w-3.5 h-3.5 mr-1" />
              <span>登入</span>
            </a>
            
            <a 
              href="https://haoka.lot-ml.com/plugreg.html?agentid=90925"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-3 py-2 bg-blue-500 dark:bg-blue-600 hover:bg-blue-600 dark:hover:bg-blue-700 text-white font-semibold rounded-lg transition-all duration-200 text-xs"
            >
              <Icon client:load icon="heroicons:user-plus" className="w-3.5 h-3.5 mr-1" />
              <span>注册</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<style>
  /* 使用 CSS 变量优化性能 */
  :root {
    --nav-transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --hover-bg: rgba(59, 130, 246, 0.05);
    --hover-bg-dark: rgba(59, 130, 246, 0.2);
  }

  /* Navigation Link Styles */
  .nav-link {
    @apply relative text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-300 font-medium px-3 py-2 rounded-lg text-base lg:text-lg;
    will-change: transform, opacity;
  }
  
  .nav-link::after {
    content: '';
    position: absolute;
    width: 0;
    height: 2px;
    bottom: 0;
    left: 50%;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    transition: all var(--nav-transition);
    transform: translateX(-50%);
    border-radius: 1px;
  }
  
  .nav-link:hover::after {
    width: 80%;
  }

  .nav-link:hover {
    @apply bg-blue-50/50 dark:bg-blue-900/20;
  }

  /* Hamburger Menu Animation */
  .navbarTogglerActive > span:nth-child(1) {
    top: 6px;
    transform: rotate(45deg);
    background-color: #3b82f6;
  }
  .navbarTogglerActive > span:nth-child(2) {
    opacity: 0;
    transform: scale(0);
  }
  .navbarTogglerActive > span:nth-child(3) {
    top: -6px;
    transform: rotate(-45deg);
    background-color: #3b82f6;
  }

  /* Text Truncation */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Focus Styles for Accessibility */
  .nav-link:focus {
    @apply outline-none ring-2 ring-blue-500 ring-offset-2 ring-offset-white dark:ring-offset-blue-950;
  }

  /* Backdrop Blur Support */
  @supports (backdrop-filter: blur(12px)) {
    .backdrop-blur-md {
      backdrop-filter: blur(12px);
    }
  }
</style>

<script is:inline>
  // 优化后的滚动事件处理
  let header;
  let ticking = false;

  function handleScroll() {
    if (!header) header = document.querySelector('header');
    if (!header) return;
    
    if (!ticking) {
      requestAnimationFrame(() => {
        header.classList.toggle('shadow-sm', window.scrollY > 20);
        ticking = false;
      });
      ticking = true;
    }
  }

  // 使用 passive 监听器优化滚动性能
  window.addEventListener('scroll', handleScroll, { passive: true });
  
  // DOM 加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      header = document.querySelector('header');
      handleScroll();
    });
  } else {
    header = document.querySelector('header');
    handleScroll();
  }
</script>
